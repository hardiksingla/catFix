<!-- templates/inspections/step2.html -->
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f4f4f4;
        color: #000000;
    }

    form {
        background-color: #ffffff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        max-width: 600px;
        margin: auto;
        border-left: 5px solid #FFCC00;
    }

    h3 {
        color: #FFCC00;
        margin-top: 20px;
    }

    button {
        padding: 10px 20px;
        font-size: 16px;
        color: #ffffff;
        background-color: #000000;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
    }

    button#start-recording {
        background-color: #FFCC00;
        color: #000000;
        margin-right: 10px;
    }

    button#start-recording:hover, button#stop-recording:hover, button#next-button:hover {
        background-color: #FFCC00;
        color: #000000;
    }

    button:disabled {
        background-color: #cccccc;
        color: #666666;
        cursor: not-allowed;
    }

    #captured-text, #summarized-text {
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
        border-left: 5px solid #FFCC00;
        color: #000000;
        font-size: 16px;
        min-height: 50px;
    }

    #captured-text {
        margin-bottom: 20px;
    }

    .tire-info {
        margin-top: 20px;
        padding: 10px;
        background-color: #f9f9f9;
        border-left: 5px solid #FFCC00;
        border-radius: 8px;
        color: #000000;
    }
</style>

<form method="post">
    {% csrf_token %}
    <div>
        <button type="button" id="start-recording">Start Recording</button>
        <button type="button" id="stop-recording" disabled>Stop Recording</button>
    </div>
    <div>
        <h3>Captured Text:</h3>
        <p id="captured-text">Start speaking to capture text...</p>
    </div>
    <div class="tire-info">
        <p><span id="tire-summary"></span></p>
    </div>
    <button type="submit" id="next-button" disabled>Next</button>
</form>

<script>
    let finalTranscript = '';
    let recognition = null;

    // Check if the browser supports Web Speech API
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onresult = function(event) {
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript + ' ';
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }
            document.getElementById('captured-text').innerText = finalTranscript + interimTranscript;

            // Stop recording if word count exceeds 10,000
            if (finalTranscript.split(' ').length >= 10000) {
                recognition.stop();
                document.getElementById('start-recording').disabled = false;
                document.getElementById('stop-recording').disabled = true;
                sendToGemini(finalTranscript);
            }
        };

        recognition.onerror = function(event) {
            console.error('Speech Recognition Error:', event.error);
        };

        recognition.onend = function() {
            sendToGemini(finalTranscript);
        };
    } else {
        alert('Your browser does not support Speech Recognition.');
    }

    document.getElementById('start-recording').onclick = function() {
        finalTranscript = '';
        recognition.start();
        document.getElementById('start-recording').disabled = true;
        document.getElementById('stop-recording').disabled = false;
    };

    document.getElementById('stop-recording').onclick = function() {
        recognition.stop();
        document.getElementById('start-recording').disabled = false;
        document.getElementById('stop-recording').disabled = true;
    };

    function sendToGemini(text) {
        fetch("{% url 'gemini_summarize_api' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({text: text}),
        })
        .then(response => response.json())
        .then(data => {
            populateTireInfo(data.summary);
            document.getElementById('next-button').disabled = false;
        })
        .catch(error => console.error('Error:', error));
    }

    function populateTireInfo(summary) {
        document.getElementById('tire-summary').innerText = summary.slice(0, 1000);
    }

    function extractInfo(text, label) {
        const regex = new RegExp(`${label}:?\\s*(.*?)(?=(\\s*Tire|\\s*$))`, 'i');
        const match = text.match(regex);
        return match ? match[1].trim() : '';
    }
</script>
