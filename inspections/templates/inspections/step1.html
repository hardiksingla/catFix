<!-- templates/inspections/step1.html -->
<form method="post" enctype="multipart/form-data" action="{% url 'step2' %}">
    {% csrf_token %}

    <!-- Image Upload Field -->
    <label for="image">Upload Image:</label>
    <input type="file" id="image" name="image" accept="image/*" onchange="previewImage(event)">

    <!-- Image Preview -->
    <div>
        <img id="image-preview" src="" alt="Image Preview" style="display:none; max-width: 100%; height: auto;">
    </div>

    <!-- Process Button -->
    <button type="button" onclick="processImage()">Process</button>

    <!-- Next Button -->
    <button type="submit">Next</button>
</form>

<!-- Display Detected Barcode String -->
<div id="extracted-text"></div>

<!-- Display Date and Time -->
<div id="date-time"></div>

<!-- Display Location -->
<div id="location">
    <p>Latitude: <span id="latitude"></span></p>
    <p>Longitude: <span id="longitude"></span></p>
</div>

<!-- Signature Pad -->
<div>
    <label for="signature">Draw your signature:</label>
    <canvas id="signature-pad" width="400" height="200" style="border:1px solid #000;"></canvas>
    <input type="hidden" name="signature" id="signature-input">
    <button type="button" onclick="saveSignature()">Save Signature</button>
</div>

<script>
    // Initialize variables for drawing on the canvas
    let isDrawing = false;
    let x = 0;
    let y = 0;
    const canvas = document.getElementById('signature-pad');
    const context = canvas.getContext('2d');

    // Function to start drawing
    canvas.addEventListener('mousedown', e => {
        isDrawing = true;
        x = e.offsetX;
        y = e.offsetY;
    });

    // Function to stop drawing
    canvas.addEventListener('mouseup', () => {
        isDrawing = false;
        x = 0;
        y = 0;
    });

    // Function to draw on the canvas
    canvas.addEventListener('mousemove', e => {
        if (isDrawing) {
            context.beginPath();
            context.moveTo(x, y);
            context.lineTo(e.offsetX, e.offsetY);
            context.stroke();
            x = e.offsetX;
            y = e.offsetY;
        }
    });

    // Handle touch events for mobile devices
    canvas.addEventListener('touchstart', e => {
        const touch = e.touches[0];
        x = touch.clientX - canvas.offsetLeft;
        y = touch.clientY - canvas.offsetTop;
        isDrawing = true;
    });

    canvas.addEventListener('touchmove', e => {
        if (isDrawing) {
            const touch = e.touches[0];
            context.beginPath();
            context.moveTo(x, y);
            context.lineTo(touch.clientX - canvas.offsetLeft, touch.clientY - canvas.offsetTop);
            context.stroke();
            x = touch.clientX - canvas.offsetLeft;
            y = touch.clientY - canvas.offsetTop;
        }
    });

    canvas.addEventListener('touchend', () => {
        isDrawing = false;
        x = 0;
        y = 0;
    });

    // Function to Preview Image
    function previewImage(event) {
        const imagePreview = document.getElementById('image-preview');
        const file = event.target.files[0];
        const reader = new FileReader();

        reader.onload = function () {
            imagePreview.src = reader.result;
            imagePreview.style.display = 'block';
        }

        if (file) {
            reader.readAsDataURL(file);
        }
    }

    // Function to Process Image
    async function processImage() {
        const imageInput = document.getElementById('image');
        const file = imageInput.files[0];
        if (!file) {
            alert('Please upload an image first.');
            return;
        }

        const formData = new FormData();
        formData.append('image', file);

        const response = await fetch("{% url 'process_image' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });

        if (response.ok) {
            const result = await response.json();
            document.getElementById('extracted-text').innerText = result.text;

            // Display current date and time
            const now = new Date();
            document.getElementById('date-time').innerText = `Date and Time: ${now.toLocaleString()}`;

            // Get and display current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    document.getElementById('latitude').innerText = latitude.toFixed(6);
                    document.getElementById('longitude').innerText = longitude.toFixed(6);
                });
            } else {
                document.getElementById('location').innerText = 'Geolocation is not supported by this browser.';
            }
        } else {
            document.getElementById('extracted-text').innerText = 'An error occurred while processing the image.';
        }
    }

    // Function to Save Signature
    function saveSignature() {
        var canvas = document.getElementById('signature-pad');
        var signatureInput = document.getElementById('signature-input');
        signatureInput.value = canvas.toDataURL();
    }
</script>